# QGIS Plugin Packaging Workflow
# Creates distributable ZIP for plugins.qgis.org

name: Package QGIS Plugin

on:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:

jobs:
  package-plugin:
    name: Package QGIS Plugin
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true  # Required for h2gis-native-libs.zip

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get version from metadata
        id: version
        run: |
          VERSION=$(grep -E "^version=" qgis-plugin/h2gis_driver_installer/metadata.txt | cut -d= -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Plugin version: $VERSION"

      - name: Validate plugin structure
        run: |
          cd qgis-plugin/h2gis_driver_installer
          
          echo "=== Checking required files ==="
          test -f __init__.py || { echo "ERROR: __init__.py missing"; exit 1; }
          test -f metadata.txt || { echo "ERROR: metadata.txt missing"; exit 1; }
          echo "[OK] Required files present"
          
          echo ""
          echo "=== Validating metadata.txt ==="
          # Check required QGIS plugin metadata fields
          REQUIRED_FIELDS="name version qgisMinimumVersion description author email"
          for field in $REQUIRED_FIELDS; do
            if grep -q "^${field}=" metadata.txt; then
              VALUE=$(grep "^${field}=" metadata.txt | cut -d= -f2-)
              echo "[OK] $field = $VALUE"
            else
              echo "ERROR: Missing required field: $field"
              exit 1
            fi
          done
          
          echo ""
          echo "=== Checking Python syntax ==="
          python -m py_compile *.py
          echo "[OK] Python syntax valid"
          
          echo ""
          echo "=== Checking __init__.py exports classFactory ==="
          if grep -q "def classFactory" __init__.py; then
            echo "[OK] classFactory function found"
          else
            echo "ERROR: classFactory function not found in __init__.py"
            exit 1
          fi
          
          cd ../..

      - name: Create plugin ZIP
        run: |
          cd qgis-plugin
          
          # Create ZIP with proper structure for QGIS
          # The ZIP must contain a folder with the plugin name at root level
          # Exclude macOS metadata files and Python cache
          zip -r ../h2gis_driver_installer.zip h2gis_driver_installer \
            -x "*.pyc" \
            -x "*__pycache__*" \
            -x "*.git*" \
            -x "*__MACOSX*" \
            -x "*.DS_Store"
          
          cd ..
          
          # Show contents
          echo "=== ZIP contents ==="
          unzip -l h2gis_driver_installer.zip
          
          # Verify root folder exists
          echo ""
          echo "=== Verifying structure ==="
          ROOT_FOLDER=$(unzip -l h2gis_driver_installer.zip | grep -E "^\s+0\s+" | head -1 | awk '{print $NF}')
          echo "Root folder: $ROOT_FOLDER"
          if [[ "$ROOT_FOLDER" == "h2gis_driver_installer/" ]]; then
            echo "Structure OK - plugin folder at root"
          else
            echo "ERROR: Expected h2gis_driver_installer/ at root"
            exit 1
          fi
          
          # Get size
          SIZE=$(stat -c%s h2gis_driver_installer.zip)
          echo "ZIP size: $SIZE bytes"

      # Prepare folder structure for GitHub artifact
      # GitHub Actions puts files flat, so we need to create the parent folder
      - name: Prepare artifact with correct structure
        run: |
          mkdir -p artifact_staging/h2gis_driver_installer
          cp -r qgis-plugin/h2gis_driver_installer/* artifact_staging/h2gis_driver_installer/
          # Remove unwanted files
          find artifact_staging -name "*.pyc" -delete
          find artifact_staging -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          find artifact_staging -name ".DS_Store" -delete
          echo "Artifact structure:"
          find artifact_staging -type f | head -20

      # This artifact can be directly installed in QGIS via "Install from ZIP"
      - name: Upload QGIS-ready plugin
        uses: actions/upload-artifact@v4
        with:
          name: h2gis_driver_installer
          path: artifact_staging/
          retention-days: 90

      - name: Upload to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: h2gis_driver_installer.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Test plugin can be loaded (basic import test)
  test-plugin:
    name: Test Plugin Import
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true  # Required for h2gis-native-libs.zip

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: pip install requests

      - name: Test plugin imports
        shell: python
        run: |
          import sys
          import os
          
          # Add plugin to path
          sys.path.insert(0, 'qgis-plugin')
          
          # Mock QGIS modules
          class MockQgis:
              Info = 0
              Warning = 1
              Critical = 2
              Success = 3
          
          class MockQgsMessageLog:
              @staticmethod
              def logMessage(msg, cat, level):
                  pass
          
          class MockQgsApplication:
              @staticmethod
              def qgisSettingsDirPath():
                  return os.path.expanduser("~/.qgis_test")
              @staticmethod
              def instance():
                  return None
          
          class MockQgsSettings:
              def __init__(self):
                  self._data = {}
              def value(self, key, default=None):
                  return self._data.get(key, default)
              def setValue(self, key, val):
                  self._data[key] = val
              def remove(self, key):
                  self._data.pop(key, None)
          
          # Inject mocks
          import types
          sys.modules['qgis'] = types.ModuleType('qgis')
          sys.modules['qgis.core'] = types.ModuleType('qgis.core')
          sys.modules['qgis.core'].Qgis = MockQgis
          sys.modules['qgis.core'].QgsMessageLog = MockQgsMessageLog
          sys.modules['qgis.core'].QgsApplication = MockQgsApplication
          sys.modules['qgis.core'].QgsSettings = MockQgsSettings
          sys.modules['qgis.core'].QgsVectorLayer = None
          sys.modules['qgis.core'].QgsProject = None
          sys.modules['qgis.core'].QgsCoordinateReferenceSystem = None
          
          # Mock osgeo.gdal
          sys.modules['osgeo'] = types.ModuleType('osgeo')
          sys.modules['osgeo.gdal'] = types.ModuleType('osgeo.gdal')
          sys.modules['osgeo.gdal'].VersionInfo = lambda x='VERSION_NUM': '3100000'
          sys.modules['osgeo.gdal'].__version__ = '3.10.0'
          
          # Test imports
          print("Testing plugin imports on", sys.platform)
          
          from h2gis_driver_installer import classFactory
          print("[OK] __init__.py")
          
          from h2gis_driver_installer.platform_detector import get_platform_info
          info = get_platform_info()
          print(f"[OK] platform_detector.py - {info['os']}/{info['arch']}")
          
          from h2gis_driver_installer.downloader import H2GIS_LIB_URL, get_driver_download_url
          print(f"[OK] downloader.py - H2GIS URL: {H2GIS_LIB_URL[:50]}...")
          
          from h2gis_driver_installer.installer import H2GISInstaller
          print("[OK] installer.py")
          
          from h2gis_driver_installer.demo_database import DemoDatabase
          print("[OK] demo_database.py")
          
          print("\nAll imports successful!")
      - name: Run unit tests
        shell: python
        run: |
          import sys
          import os
          import unittest
          
          # Add plugin to path
          sys.path.insert(0, 'qgis-plugin')
          
          # Mock QGIS modules
          class MockQgis:
              Info = 0
              Warning = 1
              Critical = 2
              Success = 3
          
          class MockQgsMessageLog:
              @staticmethod
              def logMessage(msg, cat, level):
                  pass
          
          class MockQgsApplication:
              @staticmethod
              def qgisSettingsDirPath():
                  return os.path.expanduser("~/.qgis_test")
              @staticmethod
              def instance():
                  return None
          
          class MockQgsSettings:
              def __init__(self):
                  self._data = {}
              def value(self, key, default=None):
                  return self._data.get(key, default)
              def setValue(self, key, val):
                  self._data[key] = val
              def remove(self, key):
                  self._data.pop(key, None)
          
          # Inject mocks
          import types
          sys.modules['qgis'] = types.ModuleType('qgis')
          sys.modules['qgis.core'] = types.ModuleType('qgis.core')
          sys.modules['qgis.core'].Qgis = MockQgis
          sys.modules['qgis.core'].QgsMessageLog = MockQgsMessageLog
          sys.modules['qgis.core'].QgsApplication = MockQgsApplication
          sys.modules['qgis.core'].QgsSettings = MockQgsSettings
          sys.modules['qgis.core'].QgsVectorLayer = None
          sys.modules['qgis.core'].QgsProject = None
          sys.modules['qgis.core'].QgsCoordinateReferenceSystem = None
          
          # Mock osgeo.gdal
          sys.modules['osgeo'] = types.ModuleType('osgeo')
          sys.modules['osgeo.gdal'] = types.ModuleType('osgeo.gdal')
          sys.modules['osgeo.gdal'].VersionInfo = lambda x='VERSION_NUM': '3100000'
          sys.modules['osgeo.gdal'].__version__ = '3.10.0'
          
          # Discover and run tests
          print("Running unit tests...")
          loader = unittest.TestLoader()
          suite = loader.discover('qgis-plugin/h2gis_driver_installer/tests', pattern='test_*.py')
          
          runner = unittest.TextTestRunner(verbosity=2)
          result = runner.run(suite)
          
          if not result.wasSuccessful():
              sys.exit(1)
          print("\n[OK] All tests passed!")