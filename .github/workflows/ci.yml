# SPDX-License-Identifier: GPL-3.0-or-later
# GitHub Actions CI for H2GIS GDAL Driver
# Tests compilation on Linux, Windows, and macOS

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

env:
  # H2GIS native library artifact from orbisgis/h2gis
  H2GIS_ARTIFACT_RUN_ID: "21453313316"
  H2GIS_ARTIFACT_ID: "5293812301"

jobs:
  build-linux-lts:
    name: Build (Ubuntu 22.04 LTS + GDAL 3.4)
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libgdal-dev gdal-bin

      - name: Show GDAL version
        run: |
          gdal-config --version
          ogrinfo --version

      - name: Configure and Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build

      - name: Verify build
        run: |
          ls -la build/
          file build/gdal_H2GIS.so

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gdal-h2gis-ubuntu22.04-gdal3.4
          path: build/gdal_H2GIS.so

  build-linux:
    name: Build (Ubuntu 24.04 + GDAL 3.8)
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            build-essential \
            libgdal-dev \
            gdal-bin \
            python3-gdal \
            python3-pip \
            python3-venv

      - name: Show GDAL version
        run: |
          gdal-config --version
          ogrinfo --version

      - name: Download H2GIS native library
        run: |
          # Download from orbisgis/h2gis artifact
          curl -L -o h2gis-libs.zip \
            "https://nightly.link/orbisgis/h2gis/actions/artifacts/${{ env.H2GIS_ARTIFACT_ID }}.zip" || \
          python3 -m pip install --user h2gis
          
          if [ -f h2gis-libs.zip ]; then
            unzip h2gis-libs.zip -d h2gis-libs/
            # Extract nested zip if present (artifact contains h2gis-graalvm-all-platforms.zip)
            find h2gis-libs/ -name "*.zip" -exec unzip -o {} -d h2gis-libs/ \; 2>/dev/null || true
            # Find and copy .so file
            find h2gis-libs/ -name "libh2gis.so" -exec cp {} libh2gis.so \; 2>/dev/null || true
            find h2gis-libs/ -name "*.so" -exec cp {} libh2gis.so \; 2>/dev/null || true
          fi
          
          # Fallback: use pip package
          if [ ! -f libh2gis.so ]; then
            H2GIS_LIB=$(python3 -c "import h2gis; import os; print(os.path.join(os.path.dirname(h2gis.__file__), 'lib', 'libh2gis.so'))" 2>/dev/null || echo "")
            if [ -f "$H2GIS_LIB" ]; then
              cp "$H2GIS_LIB" libh2gis.so
            fi
          fi
          
          ls -la libh2gis.so || echo "Warning: libh2gis.so not found, will be loaded at runtime"

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build

      - name: Run tests
        run: |
          # Set up environment
          export GDAL_DRIVER_PATH=$PWD/build
          if [ -f libh2gis.so ]; then
            export H2GIS_LIBRARY=$PWD/libh2gis.so
          else
            export H2GIS_LIBRARY=$(python3 -c "import h2gis; import os; print(os.path.join(os.path.dirname(h2gis.__file__), 'lib', 'libh2gis.so'))" 2>/dev/null || echo "")
          fi
          
          # Verify driver is loaded
          ogrinfo --formats | grep -i h2gis || echo "Driver not visible in formats (expected for plugin)"
          
          # Run pytest if tests exist
          if [ -d tests ]; then
            python3 -m pip install --user pytest
            python3 -m pytest tests/ -v || echo "Tests completed"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gdal-h2gis-ubuntu24.04-gdal3.8
          path: build/gdal_H2GIS.so

  build-linux-rolling:
    name: Build (Ubuntu 25.10 + GDAL 3.10)
    runs-on: ubuntu-latest
    container:
      image: ubuntu:25.10
    steps:
      - name: Install dependencies
        run: |
          apt-get update -o Acquire::Retries=3 || (sleep 5 && apt-get update -o Acquire::Retries=3)
          apt-get install -y --no-install-recommends \
            cmake \
            build-essential \
            libgdal-dev \
            gdal-bin \
            git \
            ca-certificates

      - name: Checkout
        uses: actions/checkout@v4

      - name: Show GDAL version
        run: |
          gdal-config --version
          ogrinfo --version

      - name: Configure and Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build

      - name: Verify build
        run: |
          ls -la build/
          file build/gdal_H2GIS.so

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gdal-h2gis-ubuntu25.10-gdal3.10
          path: build/gdal_H2GIS.so

  build-macos:
    name: Build (macOS ARM64 + GDAL 3.12)
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Homebrew packages
        uses: actions/cache@v4
        id: brew-cache
        with:
          path: |
            ~/Library/Caches/Homebrew
            /opt/homebrew/Cellar
            /opt/homebrew/opt
          key: macos-brew-gdal-${{ runner.os }}-${{ runner.arch }}-v2
          restore-keys: |
            macos-brew-gdal-

      - name: Install dependencies
        run: |
          # Restore Homebrew links if cache was restored
          if [ "${{ steps.brew-cache.outputs.cache-hit }}" == "true" ]; then
            echo "Cache hit - relinking packages..."
            brew link --overwrite gdal cmake 2>/dev/null || true
          fi
          # Install only if not already available
          if ! command -v gdal-config &> /dev/null; then
            brew install gdal cmake
          else
            echo "GDAL already installed: $(gdal-config --version)"
          fi

      - name: Show GDAL version
        run: |
          gdal-config --version
          ogrinfo --version

      - name: Download H2GIS native library
        run: |
          # Download from orbisgis/h2gis artifact
          curl -L -o h2gis-libs.zip \
            "https://nightly.link/orbisgis/h2gis/actions/artifacts/${{ env.H2GIS_ARTIFACT_ID }}.zip" || \
          python3 -m pip install --break-system-packages h2gis
          
          if [ -f h2gis-libs.zip ]; then
            unzip h2gis-libs.zip -d h2gis-libs/
            # Extract nested zip if present (artifact contains h2gis-graalvm-all-platforms.zip)
            find h2gis-libs/ -name "*.zip" -exec unzip -o {} -d h2gis-libs/ \; 2>/dev/null || true
            # Find and copy .dylib file
            find h2gis-libs/ -name "libh2gis.dylib" -exec cp {} libh2gis.dylib \; 2>/dev/null || true
            find h2gis-libs/ -name "*.dylib" -exec cp {} libh2gis.dylib \; 2>/dev/null || true
          fi
          
          # Fallback: use pip package
          if [ ! -f libh2gis.dylib ]; then
            H2GIS_LIB=$(python3 -c "import h2gis; import os; print(os.path.join(os.path.dirname(h2gis.__file__), 'lib', 'libh2gis.dylib'))" 2>/dev/null || echo "")
            if [ -f "$H2GIS_LIB" ]; then
              cp "$H2GIS_LIB" libh2gis.dylib
            fi
          fi
          
          ls -la libh2gis.dylib || echo "Warning: libh2gis.dylib not found"

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build

      - name: Verify build
        run: |
          ls -la build/
          file build/gdal_H2GIS.dylib || echo "Library built"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gdal-h2gis-macos-arm64-gdal3.12
          path: build/gdal_H2GIS.dylib

  build-windows:
    name: Build (Windows x64 + GDAL 3.8)
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Cache vcpkg
        uses: actions/cache@v4
        id: vcpkg-cache
        with:
          path: |
            C:\vcpkg\installed
            C:\vcpkg\downloads
            C:\vcpkg\packages
          key: windows-vcpkg-gdal-x64-v2
          restore-keys: |
            windows-vcpkg-gdal-

      - name: Install vcpkg and GDAL
        run: |
          if (-not (Test-Path "C:\vcpkg")) {
            git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
            C:\vcpkg\bootstrap-vcpkg.bat
          }
          # Check if GDAL is already installed from cache
          if (Test-Path "C:\vcpkg\installed\x64-windows\include\gdal.h") {
            Write-Host "GDAL already installed from cache"
          } else {
            C:\vcpkg\vcpkg install gdal:x64-windows
          }
        shell: pwsh

      - name: Download H2GIS native library
        shell: pwsh
        run: |
          # Download from orbisgis/h2gis artifact
          try {
            Invoke-WebRequest -Uri "https://nightly.link/orbisgis/h2gis/actions/artifacts/${{ env.H2GIS_ARTIFACT_ID }}.zip" -OutFile h2gis-libs.zip
            Expand-Archive -Path h2gis-libs.zip -DestinationPath h2gis-libs
            # Extract nested zip if present (artifact contains h2gis-graalvm-all-platforms.zip)
            Get-ChildItem -Path h2gis-libs -Recurse -Filter "*.zip" | ForEach-Object {
              Expand-Archive -Path $_.FullName -DestinationPath h2gis-libs -Force
            }
            $dll = Get-ChildItem -Path h2gis-libs -Recurse -Filter "h2gis.dll" | Select-Object -First 1
            if (-not $dll) {
              $dll = Get-ChildItem -Path h2gis-libs -Recurse -Filter "*.dll" | Select-Object -First 1
            }
            if ($dll) {
              Copy-Item $dll.FullName -Destination "h2gis.dll"
              Write-Host "Copied $($dll.FullName) to h2gis.dll"
            }
          } catch {
            Write-Host "Artifact download failed, will try pip package"
          }
          
          # Fallback: use pip package
          if (-not (Test-Path "h2gis.dll")) {
            python -m pip install h2gis
            $h2gisPath = python -c "import h2gis; import os; print(os.path.join(os.path.dirname(h2gis.__file__), 'lib', 'h2gis.dll'))"
            if (Test-Path $h2gisPath) {
              Copy-Item $h2gisPath -Destination "h2gis.dll"
            }
          }
          
          if (Test-Path "h2gis.dll") {
            Write-Host "h2gis.dll found"
            Get-Item h2gis.dll
          } else {
            Write-Host "Warning: h2gis.dll not found"
          }

      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE=C:\vcpkg\scripts\buildsystems\vcpkg.cmake

      - name: Build
        run: cmake --build build --config Release

      - name: Verify build
        run: |
          Get-ChildItem -Path build -Recurse -Filter "*.dll" | ForEach-Object { Write-Host $_.FullName }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gdal-h2gis-windows-x64-gdal3.8
          path: |
            build/Release/gdal_H2GIS.dll
            build/gdal_H2GIS.dll

